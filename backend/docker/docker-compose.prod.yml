# Survey360 Production Docker Compose
# High-Throughput Infrastructure for 500K+ concurrent submissions
# 
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#
# Services:
#   - API (3 replicas with load balancing)
#   - Celery Workers (5 replicas)
#   - Celery Beat (scheduler)
#   - Redis Cluster (6 nodes: 3 masters + 3 replicas)
#   - MongoDB Sharded Cluster (3 shards + config servers + routers)
#   - Nginx (load balancer)
#   - Flower (Celery monitoring)

version: '3.9'

x-common-env: &common-env
  MONGO_URL: mongodb://mongos1:27017,mongos2:27017/survey360?replicaSet=false
  REDIS_URL: redis://:${REDIS_PASSWORD:-survey360redis}@redis-node-1:6379
  CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-survey360redis}@redis-node-1:6379/0
  CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-survey360redis}@redis-node-1:6379/0
  DB_NAME: survey360
  EMERGENT_LLM_KEY: ${EMERGENT_LLM_KEY}

services:
  # ============================================
  # NGINX LOAD BALANCER
  # ============================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api1
      - api2
      - api3
    networks:
      - survey360-network
    restart: always
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # API SERVERS (3 replicas)
  # ============================================
  api1:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      <<: *common-env
      SERVER_ID: api1
    depends_on:
      - mongos1
      - redis-node-1
    networks:
      - survey360-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  api2:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      <<: *common-env
      SERVER_ID: api2
    depends_on:
      - mongos1
      - redis-node-1
    networks:
      - survey360-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  api3:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      <<: *common-env
      SERVER_ID: api3
    depends_on:
      - mongos1
      - redis-node-1
    networks:
      - survey360-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # CELERY WORKERS (5 replicas)
  # ============================================
  celery-worker-1:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app worker --loglevel=info --concurrency=4 -Q critical,submissions,high_priority,default
    environment:
      <<: *common-env
      WORKER_ID: worker1
    depends_on:
      - redis-node-1
      - mongos1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  celery-worker-2:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app worker --loglevel=info --concurrency=4 -Q critical,submissions,high_priority,default
    environment:
      <<: *common-env
      WORKER_ID: worker2
    depends_on:
      - redis-node-1
      - mongos1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  celery-worker-3:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app worker --loglevel=info --concurrency=4 -Q submissions,high_priority,default,low_priority
    environment:
      <<: *common-env
      WORKER_ID: worker3
    depends_on:
      - redis-node-1
      - mongos1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  celery-worker-4:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app worker --loglevel=info --concurrency=4 -Q default,low_priority,bulk
    environment:
      <<: *common-env
      WORKER_ID: worker4
    depends_on:
      - redis-node-1
      - mongos1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  celery-worker-5:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app worker --loglevel=info --concurrency=4 -Q bulk,low_priority
    environment:
      <<: *common-env
      WORKER_ID: worker5
    depends_on:
      - redis-node-1
      - mongos1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # ============================================
  # CELERY BEAT (Scheduler)
  # ============================================
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app beat --loglevel=info
    environment:
      <<: *common-env
    depends_on:
      - redis-node-1
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # FLOWER (Celery Monitoring)
  # ============================================
  flower:
    build:
      context: .
      dockerfile: Dockerfile.api
    command: celery -A utils.celery_app flower --port=5555 --basic_auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-survey360flower}
    environment:
      <<: *common-env
    ports:
      - "5555:5555"
    depends_on:
      - redis-node-1
    networks:
      - survey360-network
    restart: always

  # ============================================
  # REDIS CLUSTER (6 nodes)
  # ============================================
  redis-node-1:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-1.conf:/etc/redis/redis.conf:ro
      - redis-data-1:/data
    ports:
      - "6379:6379"
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis-node-2:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-2.conf:/etc/redis/redis.conf:ro
      - redis-data-2:/data
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis-node-3:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-3.conf:/etc/redis/redis.conf:ro
      - redis-data-3:/data
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis-node-4:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-4.conf:/etc/redis/redis.conf:ro
      - redis-data-4:/data
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis-node-5:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-5.conf:/etc/redis/redis.conf:ro
      - redis-data-5:/data
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  redis-node-6:
    image: redis:7.2-alpine
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./redis/redis-node-6.conf:/etc/redis/redis.conf:ro
      - redis-data-6:/data
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  # Redis Cluster Initialization
  redis-cluster-init:
    image: redis:7.2-alpine
    command: >
      sh -c "
        sleep 10 &&
        echo 'Creating Redis cluster...' &&
        redis-cli --cluster create 
          redis-node-1:6379 
          redis-node-2:6379 
          redis-node-3:6379 
          redis-node-4:6379 
          redis-node-5:6379 
          redis-node-6:6379 
          --cluster-replicas 1 
          -a ${REDIS_PASSWORD:-survey360redis} 
          --cluster-yes
      "
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
      - redis-node-4
      - redis-node-5
      - redis-node-6
    networks:
      - survey360-network
    restart: "no"

  # ============================================
  # MONGODB CONFIG SERVERS (3 nodes)
  # ============================================
  mongo-config-1:
    image: mongo:7.0
    command: mongod --configsvr --replSet configRS --port 27019 --bind_ip_all
    volumes:
      - mongo-config-1:/data/configdb
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  mongo-config-2:
    image: mongo:7.0
    command: mongod --configsvr --replSet configRS --port 27019 --bind_ip_all
    volumes:
      - mongo-config-2:/data/configdb
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  mongo-config-3:
    image: mongo:7.0
    command: mongod --configsvr --replSet configRS --port 27019 --bind_ip_all
    volumes:
      - mongo-config-3:/data/configdb
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G

  # ============================================
  # MONGODB SHARD 1 (3 node replica set)
  # ============================================
  mongo-shard1-1:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard1RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard1-1:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard1-2:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard1RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard1-2:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard1-3:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard1RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard1-3:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============================================
  # MONGODB SHARD 2 (3 node replica set)
  # ============================================
  mongo-shard2-1:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard2RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard2-1:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard2-2:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard2RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard2-2:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard2-3:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard2RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard2-3:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============================================
  # MONGODB SHARD 3 (3 node replica set)
  # ============================================
  mongo-shard3-1:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard3RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard3-1:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard3-2:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard3RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard3-2:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo-shard3-3:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard3RS --port 27018 --bind_ip_all --wiredTigerCacheSizeGB 2
    volumes:
      - mongo-shard3-3:/data/db
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============================================
  # MONGODB ROUTERS (Mongos)
  # ============================================
  mongos1:
    image: mongo:7.0
    command: mongos --configdb configRS/mongo-config-1:27019,mongo-config-2:27019,mongo-config-3:27019 --bind_ip_all --port 27017
    ports:
      - "27017:27017"
    depends_on:
      - mongo-config-1
      - mongo-config-2
      - mongo-config-3
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  mongos2:
    image: mongo:7.0
    command: mongos --configdb configRS/mongo-config-1:27019,mongo-config-2:27019,mongo-config-3:27019 --bind_ip_all --port 27017
    depends_on:
      - mongo-config-1
      - mongo-config-2
      - mongo-config-3
    networks:
      - survey360-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ============================================
  # MONGODB INITIALIZATION
  # ============================================
  mongo-init:
    image: mongo:7.0
    depends_on:
      - mongo-config-1
      - mongo-config-2
      - mongo-config-3
      - mongo-shard1-1
      - mongo-shard1-2
      - mongo-shard1-3
      - mongo-shard2-1
      - mongo-shard2-2
      - mongo-shard2-3
      - mongo-shard3-1
      - mongo-shard3-2
      - mongo-shard3-3
      - mongos1
    volumes:
      - ./mongodb/init-sharding.sh:/init-sharding.sh:ro
    command: /bin/bash /init-sharding.sh
    networks:
      - survey360-network
    restart: "no"

  # ============================================
  # FRONTEND
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - REACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL:-http://localhost}
    networks:
      - survey360-network
    restart: always

# ============================================
# VOLUMES
# ============================================
volumes:
  # Redis volumes
  redis-data-1:
  redis-data-2:
  redis-data-3:
  redis-data-4:
  redis-data-5:
  redis-data-6:
  
  # MongoDB config server volumes
  mongo-config-1:
  mongo-config-2:
  mongo-config-3:
  
  # MongoDB shard 1 volumes
  mongo-shard1-1:
  mongo-shard1-2:
  mongo-shard1-3:
  
  # MongoDB shard 2 volumes
  mongo-shard2-1:
  mongo-shard2-2:
  mongo-shard2-3:
  
  # MongoDB shard 3 volumes
  mongo-shard3-1:
  mongo-shard3-2:
  mongo-shard3-3:

# ============================================
# NETWORKS
# ============================================
networks:
  survey360-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
