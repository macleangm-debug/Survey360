# Survey360 Ingress Configuration
# Nginx Ingress Controller with SSL/TLS termination

---
# ============================================
# MAIN INGRESS - Frontend & API
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: survey360-ingress
  namespace: survey360
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    # Compression
    nginx.ingress.kubernetes.io/enable-brotli: "true"
    # Cert-manager for automatic TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - survey360.yourdomain.com
    - api.survey360.yourdomain.com
    secretName: survey360-tls
  rules:
  # Frontend - main domain
  - host: survey360.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
      # API routes through frontend nginx
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 8001
  # API subdomain (optional)
  - host: api.survey360.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 8001

---
# ============================================
# FLOWER INGRESS - Celery Monitoring
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: flower-ingress
  namespace: survey360
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Basic auth for additional security
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: flower-auth
    nginx.ingress.kubernetes.io/auth-realm: "Flower - Celery Monitoring"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - flower.survey360.yourdomain.com
    secretName: flower-tls
  rules:
  - host: flower.survey360.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: flower
            port:
              number: 5555

---
# ============================================
# HIGH-THROUGHPUT INGRESS - Submissions API
# Separate ingress with optimized settings for bulk submissions
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: survey360-submissions-ingress
  namespace: survey360
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Higher limits for bulk submissions
    nginx.ingress.kubernetes.io/proxy-body-size: "500m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    # Higher rate limits for submission endpoints
    nginx.ingress.kubernetes.io/limit-rps: "10000"
    nginx.ingress.kubernetes.io/limit-connections: "1000"
    # Connection keepalive
    nginx.ingress.kubernetes.io/upstream-keepalive-connections: "100"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - submissions.survey360.yourdomain.com
    secretName: submissions-tls
  rules:
  - host: submissions.survey360.yourdomain.com
    http:
      paths:
      - path: /api/survey360/submissions
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 8001

---
# ============================================
# NETWORK POLICIES
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-network-policy
  namespace: survey360
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8001
  # Allow from frontend
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8001
  egress:
  # Allow to MongoDB
  - to:
    - podSelector:
        matchLabels:
          app: mongos
    ports:
    - protocol: TCP
      port: 27017
  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  # Allow DNS
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  # Allow external (for LLM API calls)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        except:
        - 10.0.0.0/8
        - 192.168.0.0/16
        - 172.16.0.0/12
    ports:
    - protocol: TCP
      port: 443
